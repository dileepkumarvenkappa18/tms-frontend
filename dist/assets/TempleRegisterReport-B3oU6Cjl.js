import{W as oe,q as ae,e as ne,r as b,c as T,E as re,G as F,s as ie,I as E,h as u,j as D,i as l,z as de,J as ue,K as ce,C as x,t as a,y as me,F as L,l as M,w as N,v as j,k as pe,X as q,Y as O,A as ge,o as c,n as X}from"./index-CSzH4brs.js";const ve={class:"min-h-screen bg-gray-50"},fe={key:0,class:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-4"},ye={class:"bg-white shadow-sm border-b border-gray-200 rounded-2xl"},be={class:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6"},xe={class:"flex items-center justify-between"},he={class:"text-gray-600 mt-1"},we={key:0,class:"text-indigo-600 font-medium"},_e={key:1,class:"text-indigo-600 font-medium"},De={class:"flex items-center space-x-4"},ke={class:"bg-indigo-50 px-4 py-2 rounded-lg border border-indigo-200"},Te={class:"text-indigo-800 font-medium"},Se={class:"text-indigo-600 text-sm ml-2"},Ie={key:1,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},Fe={class:"bg-white rounded-lg p-6 flex items-center space-x-3"},Re={class:"text-gray-900 font-medium"},Ae={key:2,class:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-4"},Ce={class:"bg-red-50 border border-red-200 rounded-md p-4"},$e={class:"flex"},Ee={class:"ml-3"},Le={class:"mt-1 text-sm text-red-700"},Me={class:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"},Ne={class:"bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden mb-8"},Ue={class:"p-6"},ze={class:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"},Be={class:"flex flex-wrap gap-2"},Pe=["onClick","disabled"],Ve={class:"flex flex-wrap gap-2"},je=["onClick","disabled"],qe={key:0,class:"mb-6 p-4 bg-gray-50 border border-gray-200 rounded-lg"},Oe={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Xe=["disabled","max"],Ye=["disabled","min","max"],We={class:"border-t border-gray-200 pt-6"},Ge={class:"flex flex-col md:flex-row md:items-center md:justify-between"},He={class:"flex items-center space-x-3"},Je={class:"relative"},Ke=["disabled"],Qe=["value"],Ze=["disabled"],et={key:0,class:"animate-spin -ml-1 mr-2 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},tt={key:1,class:"mr-2 h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},lt={class:"bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden"},st={class:"p-6"},ot={class:"flex flex-wrap gap-2"},at={key:0,class:"inline-flex items-center px-3 py-1.5 rounded-full text-sm bg-indigo-100 text-indigo-800"},nt={class:"inline-flex items-center px-3 py-1.5 rounded-full text-sm bg-indigo-100 text-indigo-800"},rt={class:"inline-flex items-center px-3 py-1.5 rounded-full text-sm bg-indigo-100 text-indigo-800"},it={key:0},dt={class:"inline-flex items-center px-3 py-1.5 rounded-full text-sm bg-indigo-100 text-indigo-800"},ut={class:"inline-flex items-center px-3 py-1.5 rounded-full text-sm bg-indigo-100 text-indigo-800"},ct={class:"inline-flex items-center px-3 py-1.5 rounded-full text-sm bg-green-100 text-green-800"},gt={__name:"TempleRegisterReport",setup(mt){const h=re();ge();const n=oe(),k=ae(),{showToast:$}=ne(),S=b("all"),w=b("weekly"),I=b("all"),R=b("pdf"),p=b(""),g=b(""),_=b(!1),f=b(""),y=b(!1),Y=()=>{const t=new Date,e=new Date;e.setDate(t.getDate()-7),g.value=t.toISOString().split("T")[0],p.value=e.toISOString().split("T")[0]},U=[{label:"Weekly",value:"weekly"},{label:"Monthly",value:"monthly"},{label:"Yearly",value:"yearly"},{label:"Custom Range",value:"custom"}],z=[{label:"All Status",value:"all"},{label:"Approved",value:"approved"},{label:"Pending",value:"pending"},{label:"Rejected",value:"rejected"}],B=[{label:"PDF",value:"pdf"},{label:"CSV",value:"csv"},{label:"Excel",value:"excel"}],v=T(()=>h.query.from==="superadmin"),r=T(()=>h.query.tenants?h.query.tenants.split(",").filter(t=>t&&t.trim()):[]),i=T(()=>{var e,o;if(v.value&&r.value.length===1)return r.value[0];if(h.params.tenantId)return h.params.tenantId;if((e=k.user)!=null&&e.assignedTenantId)return k.user.assignedTenantId.toString();const t=localStorage.getItem("current_tenant_id");return t||(F.defaults.headers.common["X-Tenant-ID"]?F.defaults.headers.common["X-Tenant-ID"].toString():(o=k.user)!=null&&o.id?k.user.id.toString():(console.warn("No tenant ID found, using fallback"),null))}),W=T(()=>new Date().toISOString().split("T")[0]),P=T(()=>w.value==="custom"?p.value&&g.value&&new Date(p.value)<=new Date(g.value):!0);T(()=>!n.temples||!Array.isArray(n.temples)?[]:n.temples.filter(t=>{if(!t)return!1;const e=(t.status||"").toLowerCase();return e==="approved"||e==="active"}));const G=t=>{w.value=t,A();const e=new Date,o=new Date;t==="weekly"?o.setDate(e.getDate()-7):t==="monthly"?o.setDate(e.getDate()-30):t==="yearly"&&o.setDate(e.getDate()-365),t!=="custom"&&(p.value=o.toISOString().split("T")[0],g.value=e.toISOString().split("T")[0])},H=t=>{I.value=t,A()},A=()=>{f.value=""},J=t=>{if(t==="all")return"All Temples";const e=n.temples.find(o=>{var d;return((d=o==null?void 0:o.id)==null?void 0:d.toString())===(t==null?void 0:t.toString())});return e?e.name:"Unknown Temple"},K=t=>{const e=U.find(o=>o.value===t);return e?e.label:"Unknown"},Q=t=>{const e=z.find(o=>o.value===t);return e?e.label:"Unknown"},Z=t=>{const e=B.find(o=>o.value===t);return e?e.label:"Unknown"},V=t=>{if(!t)return"";try{return new Date(t).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}catch{return t||""}},ee=()=>{try{if(!i.value)throw new Error("No valid tenant ID available for report generation");const t={dateRange:w.value||"weekly",format:R.value||"pdf",startDate:p.value,endDate:g.value,isSuperAdmin:v.value,tenantId:i.value};return v.value&&r.value.length>1?(t.entityIds=r.value,t.entityId=r.value[0]):t.entityId=i.value,S.value==="all"?t.templeId="all":t.templeId=S.value.toString(),I.value!=="all"&&(t.status=I.value),console.log("Built temple register report params:",t),t}catch(t){throw console.error("Error building report params:",t),t}},C=async()=>{y.value=!0,f.value="";try{if(!i.value)throw new Error("No tenant ID available to fetch temples");if(console.log("Fetching temples for tenant ID:",i.value),n.clearTempleData(),v.value&&r.value.length>1){console.log(`Fetching temples for ${r.value.length} tenants:`,r.value);const t=[];for(const e of r.value)try{const o=await te(e);t.push(...o)}catch(o){console.warn(`Failed to fetch temples for tenant ${e}:`,o)}n.temples=t,console.log(`Set ${n.temples.length} total temples for ${r.value.length} tenants`)}else{const t=i.value;console.log(`Fetching temples for single tenant ${t}`);try{const e=await F.get("/entities");let o=[];e.data&&Array.isArray(e.data)?o=e.data:e.data&&Array.isArray(e.data.data)&&(o=e.data.data);const d=o.filter(s=>String(s.created_by)===String(t)||String(s.tenant_id)===String(t));console.log(`Filtered ${d.length} temples from ${o.length} total entities for tenant ${t}`),n.temples=d.map(s=>q.normalizeTempleData(s)),n.temples.length===0&&(console.warn(`No temples found for tenant ID ${t}`),f.value=`No temples found for tenant ID ${t}. Please verify tenant access.`)}catch(e){console.error("Error fetching entities directly:",e),console.log("Using store method as fallback");try{v.value?await n.fetchTemplesForSuperAdmin(t):await n.fetchTemples(t)}catch(o){console.error("Fallback method also failed:",o),f.value=`Failed to load temples: ${o.message}`}}}console.log(`Successfully loaded ${n.temples.length} temples for tenant ${i.value}`)}catch(t){console.error("Error in fetchTemples:",t),f.value=`Failed to load temples: ${t.message}`,$(`Failed to load temple data: ${t.message}`,"error")}finally{y.value=!1}},te=async t=>{try{console.log(`Fetching temples for tenant ${t}`);const e=await F.get("/entities");let o=[];e.data&&Array.isArray(e.data)?o=e.data:e.data&&Array.isArray(e.data.data)&&(o=e.data.data);const d=o.filter(s=>String(s.created_by)===String(t)||String(s.tenant_id)===String(t));return console.log(`Found ${d.length} temples for tenant ${t}`),d.map(s=>q.normalizeTempleData(s))}catch(e){return console.error(`Error fetching temples for tenant ${t}:`,e),[]}},le=async()=>{var t,e,o,d;if(!(_.value||!P.value)){A(),_.value=!0;try{if(!i.value)throw new Error("No valid tenant ID available for download");const s=ee(),m=O.validateReportParams({...s,type:"temple-registered"});if(!m.isValid)throw new Error(m.errors.join(", "));console.log("Downloading temple register report with params:",s);const se=await O.downloadTempleRegisteredReport(s);$(`Temple Register Report downloaded successfully: ${se.filename||"report.pdf"}`,"success")}catch(s){console.error("Download failed:",s);let m="Failed to download report. Please try again.";(t=s.message)!=null&&t.toLowerCase().includes("network error")?m="Network error. Please check your connection and try again.":((e=s.response)==null?void 0:e.status)===404?m="Report endpoint not found. The report may not be available for this configuration.":((o=s.response)==null?void 0:o.status)===403?m="You do not have permission to download this report.":((d=s.response)==null?void 0:d.status)===400?m="Invalid report parameters. Please check your selections.":s.message&&(m=s.message),f.value=m,$(`Download failed: ${m}`,"error")}finally{_.value=!1}}};return ie(async()=>{if(console.log("Temple Register Report mounted"),console.log("fromSuperadmin:",v.value),console.log("Tenant IDs from URL:",r.value),console.log("Effective tenant ID:",i.value),console.log("Route params:",h.params),console.log("User store:",k.user),console.log("Current X-Tenant-ID header:",F.defaults.headers.common["X-Tenant-ID"]),Y(),!i.value){f.value="No valid tenant ID found. Please check your access permissions.";return}n.clearTempleData(),await C()}),E(i,async(t,e)=>{t!==e&&t&&(console.log("Tenant ID changed, refetching temples:",t),n.clearTempleData(),await C())}),E(()=>h.params.tenantId,async(t,e)=>{t!==e&&t&&(console.log("Route tenant ID changed:",t),n.clearTempleData(),await C())}),E(()=>h.query.tenants,async(t,e)=>{t!==e&&t&&(console.log("Query tenants changed:",t),n.clearTempleData(),await C(),S.value="all")}),(t,e)=>{var d;const o=ce("router-link");return c(),u("div",ve,[v.value?(c(),u("div",fe,[de(o,{to:"/superadmin/reports",class:"inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"},{default:ue(()=>[...e[3]||(e[3]=[l("svg",{class:"mr-2 h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 19l-7-7m0 0l7-7m-7 7h18"})],-1),x(" Back to SuperAdmin Reports ",-1)])]),_:1})])):D("",!0),l("div",ye,[l("div",be,[l("div",xe,[l("div",null,[e[5]||(e[5]=l("h1",{class:"text-2xl font-bold text-gray-900"},"Temple Register Report",-1)),l("p",he,[e[4]||(e[4]=x(" Download registration data for your temples ",-1)),v.value&&r.value.length>1?(c(),u("span",we," (Multiple Tenants Selected: "+a(r.value.length)+") ",1)):i.value?(c(),u("span",_e," (Tenant ID: "+a(i.value)+") ",1)):D("",!0)])]),l("div",De,[l("div",ke,[l("span",Te,a(((d=me(k).user)==null?void 0:d.name)||"Tenant User"),1),l("span",Se,a(v.value?"(Super Admin)":"(Tenant)"),1)])])])])]),y.value||_.value?(c(),u("div",Ie,[l("div",Fe,[e[6]||(e[6]=l("div",{class:"animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600"},null,-1)),l("span",Re,a(_.value?"Downloading...":"Loading data..."),1)])])):D("",!0),f.value?(c(),u("div",Ae,[l("div",Ce,[l("div",$e,[e[9]||(e[9]=l("svg",{class:"h-5 w-5 text-red-400",viewBox:"0 0 20 20",fill:"currentColor"},[l("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z","clip-rule":"evenodd"})],-1)),l("div",Ee,[e[7]||(e[7]=l("h3",{class:"text-sm font-medium text-red-800"},"Error",-1)),l("p",Le,a(f.value),1)]),l("div",{class:"ml-auto pl-3"},[l("button",{onClick:A,class:"text-red-400 hover:text-red-500"},[...e[8]||(e[8]=[l("span",{class:"sr-only"},"Dismiss",-1),l("svg",{class:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor"},[l("path",{"fill-rule":"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z","clip-rule":"evenodd"})],-1)])])])])])])):D("",!0),l("div",Me,[l("div",Ne,[e[17]||(e[17]=l("div",{class:"p-6 border-b border-gray-200"},[l("h3",{class:"text-xl font-bold text-gray-900"},"Temple Register"),l("p",{class:"text-gray-600 mt-1"},"Configure filters and download your temple registration data")],-1)),l("div",Ue,[l("div",ze,[l("div",null,[e[10]||(e[10]=l("label",{class:"block text-gray-700 font-medium mb-2"},"Registration Date",-1)),l("div",Be,[(c(),u(L,null,M(U,s=>l("button",{key:s.value,onClick:m=>G(s.value),disabled:y.value,class:X(["px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed",w.value===s.value?"bg-indigo-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"])},a(s.label),11,Pe)),64))])]),l("div",null,[e[11]||(e[11]=l("label",{class:"block text-gray-700 font-medium mb-2"},"Temple Status",-1)),l("div",Ve,[(c(),u(L,null,M(z,s=>l("button",{key:s.value,onClick:m=>H(s.value),disabled:y.value,class:X(["px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed",I.value===s.value?"bg-indigo-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"])},a(s.label),11,je)),64))])])]),w.value==="custom"?(c(),u("div",qe,[l("div",Oe,[l("div",null,[e[12]||(e[12]=l("label",{class:"block text-gray-700 text-sm font-medium mb-2"},"Start Date",-1)),N(l("input",{type:"date","onUpdate:modelValue":e[0]||(e[0]=s=>p.value=s),disabled:y.value,max:g.value,class:"w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed"},null,8,Xe),[[j,p.value]])]),l("div",null,[e[13]||(e[13]=l("label",{class:"block text-gray-700 text-sm font-medium mb-2"},"End Date",-1)),N(l("input",{type:"date","onUpdate:modelValue":e[1]||(e[1]=s=>g.value=s),disabled:y.value,min:p.value,max:W.value,class:"w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed"},null,8,Ye),[[j,g.value]])])])])):D("",!0),l("div",We,[l("div",Ge,[e[16]||(e[16]=l("div",{class:"mb-4 md:mb-0"},[l("h4",{class:"text-lg font-medium text-gray-900"},"Download Report"),l("p",{class:"text-sm text-gray-600"},"Select a format and click download")],-1)),l("div",He,[l("div",Je,[N(l("select",{"onUpdate:modelValue":e[2]||(e[2]=s=>R.value=s),disabled:y.value,class:"block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed"},[(c(),u(L,null,M(B,s=>l("option",{key:s.value,value:s.value},a(s.label),9,Qe)),64))],8,Ke),[[pe,R.value]])]),l("button",{onClick:le,disabled:y.value||!P.value,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200"},[_.value?(c(),u("svg",et,[...e[14]||(e[14]=[l("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),l("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):(c(),u("svg",tt,[...e[15]||(e[15]=[l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"},null,-1)])])),x(" "+a(_.value?"Downloading...":"Download"),1)],8,Ze)])])])])]),l("div",lt,[l("div",st,[e[24]||(e[24]=l("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"Applied Filters",-1)),l("div",ot,[v.value&&r.value.length>1?(c(),u("div",at,[e[18]||(e[18]=l("span",{class:"font-medium mr-1"},"Tenants:",-1)),x(" "+a(r.value.length)+" selected ",1)])):D("",!0),l("div",nt,[e[19]||(e[19]=l("span",{class:"font-medium mr-1"},"Temple:",-1)),x(" "+a(S.value==="all"?"All Temples":J(S.value)),1)]),l("div",rt,[e[20]||(e[20]=l("span",{class:"font-medium mr-1"},"Period:",-1)),x(" "+a(K(w.value))+" ",1),w.value==="custom"&&p.value&&g.value?(c(),u("span",it," ("+a(V(p.value))+" - "+a(V(g.value))+") ",1)):D("",!0)]),l("div",dt,[e[21]||(e[21]=l("span",{class:"font-medium mr-1"},"Status:",-1)),x(" "+a(Q(I.value)),1)]),l("div",ut,[e[22]||(e[22]=l("span",{class:"font-medium mr-1"},"Format:",-1)),x(" "+a(Z(R.value)),1)]),l("div",ct,[e[23]||(e[23]=l("span",{class:"font-medium mr-1"},"Tenant ID:",-1)),x(" "+a(i.value),1)])]),e[25]||(e[25]=l("p",{class:"mt-4 text-sm text-gray-600"}," Your report will include data based on the filters above. Click Download to generate and download the report. ",-1))])])])])}}};export{gt as default};
